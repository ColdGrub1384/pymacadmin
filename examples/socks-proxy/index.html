<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title></title>
  </head>
  <body>
    <p>
      Awhile back I <a href="http://improbable.org/chris/index.php?ID=200">posted a kicker replacement</a> which was also a <a href="http://pyobjc.sf.net">PyObjC</a> promo. Since then, crankd has <a href="http://www.afp548.com/article.php?story=seeking-a-name-for-crankd">become crankd</a> and gained the ability to handle <a href="http://www.cocoadev.com/index.pl?FSEvents">filesystem events</a> and <a href="http://www.cocoadev.com/index.pl?NSWorkspace">workspace notifications</a> and is now available on Google Code:<br>
      <br>
      <a href="http://pymacadmin.googlecode.com">http://pymacadmin.googlecode.com</a>
    </p>
    <p>
      As an example of the options the native API bridge opens up, this demonstrates the ability to modify the system proxy settings based on runtime information to enable the use of an <a href="http://improbable.org/chris/index.php?ID=208">OpenSSH Dynamic Proxy</a> when the user is not on the campus network:
    </p>
    <ol>
      <li>Prerequisites:
        <ol>
          <li>Configure public key authentication for your account so it can be used without interaction (i.e. <a href="http://www.dribin.org/dave/blog/archives/2007/11/28/ssh_agent_leopard/">10.5's SSH agent</a> for authentication, username set in <code>~/.ssh/config</code>, etc.). As long as something like <code>ssh myserver.example.org date</code> works you should be fine.
          </li>
          <li>Register a LaunchAgent so launchd will keep your SSH connection open as long as you're logged in:
            <ol>
              <li>
                <a href="http://code.google.com/p/pymacadmin/source/browse/trunk/examples/socks-proxy/org.openssh.dynamic-proxy.plist">org.openssh.dynamic-proxy.plist</a> in <code>~/Library/LaunchAgents</code> (note that you must already have public key authentication configured)
              </li>
              <li>Change <code>server.example.org</code> to your server
              </li>
              <li>Register the LaunchAgent with launchd for interactive (aqua) sessions: <code>launchctl -w -S aqua load ~/Library/LaunchAgents/org.openssh.dynamic-proxy.plist</code>
              </li>
            </ol>
          </li>
        </ol>
      </li>
      <li>Copy or symlink <a href="http://code.google.com/p/pymacadmin/source/browse/trunk/bin/crankd.py">crankd.py</a> in <code>/usr/local/sbin</code>
      </li>
      <li>Copy or symlink the <a href="http://pymacadmin.googlecode.com/svn/trunk/lib/PyMacAdmin/" title="/trunk/lib/PyMacAdmin">PyMacAdmin</a> to <code>/Library/Application Support/crankd/PyMacAdmin</code>
      </li>
      <li>Copy or symlink the <a href="http://pymacadmin.googlecode.com/svn/trunk/examples/socks-proxy/ProxyManager.py">ProxyManager.py</a> to <code>/Library/Application Support/crankd/</code>
      </li>
      <li>Copy <a href="http://pymacadmin.googlecode.com/svn/trunk/examples/socks-proxy/com.googlecode.pymacadmin.crankd.plist"><code>com.googlecode.pymacadmin.crankd.plist</code></a> to <code>/Library/Preferences</code>
      </li>
      <li>Copy <a href="http://pymacadmin.googlecode.com/svn/trunk/examples/socks-proxy/com.googlecode.pymacadmin.crankd.LaunchDaemon.plist"><code>com.googlecode.pymacadmin.crankd.LaunchDaemon.plist</code></a> to <code>/Library/LaunchDaemons</code>
      </li>
      <li>Register the launch daemon with launchd:<br>
        <code>launchctl -w -S aqua load /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.LaunchDaemon.plist</code>
      </li>
      <li>Open Console.app - you should see various startup messages as crankd loads
      </li>
      <li>Put your system to sleep and wake it. After it wakes, your network preferences should have the SOCKS proxy enabled using <tt>localhost:1080</tt>
      </li>
    </ol>
  </body>
</html>
